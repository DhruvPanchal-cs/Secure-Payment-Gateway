<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Reset Password</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* password live-check styles (consistent with signup pages) */
    .pw-checklist { max-width: 520px; margin: 8px 0 12px; padding: 12px; background:#fff; border:1px solid #e5e7eb; border-radius:8px; }
    .pw-item { display:flex; gap:8px; align-items:center; font-size:0.95rem; color:#6b7280; margin:6px 0; }
    .pw-item.ok { color:#059669; }    /* green */
    .pw-item.fail { color:#ef4444; }  /* red */
    .pw-dot { width:12px; height:12px; border-radius:50%; background:#e5e7eb; display:inline-block; flex:0 0 12px; }
    .pw-dot.ok { background:#059669; }
    .pw-dot.fail { background:#ef4444; }
    .pw-hint { font-size:0.85rem; color:#9ca3af; margin-top:6px; }
    .pw-submit-disabled { opacity:0.6; cursor:not-allowed; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-md mx-auto mt-20 bg-white p-6 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">Reset Password</h2>

    {% if error %}
      <div class="mb-4 p-3 bg-red-50 text-red-800 rounded">{{ error }}</div>
    {% endif %}

    <form method="post">
      <input type="hidden" name="token" value="{{ token }}"/>

      <label class="block mb-2 text-sm text-gray-700">New password</label>
      <input id="reset_new_password" name="password" type="password" required
             class="w-full px-3 py-2 border rounded mb-3"
             placeholder="Minimum 12 chars, mix of upper/lower/digit/special">

      <label class="block mb-2 text-sm text-gray-700">Confirm new password</label>
      <input id="reset_confirm_password" name="confirm_password" type="password" required
             class="w-full px-3 py-2 border rounded mb-4"
             placeholder="Re-enter password">

      <!-- Password checklist will be injected here by JS -->
      <div id="reset_pw_checklist" class="mb-4"></div>

      <button id="reset_password_submit" class="w-full py-2 bg-indigo-600 text-white rounded">Reset Password</button>
    </form>

    <p class="mt-4 text-sm text-gray-600">Return to <a href="{{ url_for('index') }}" class="text-indigo-600">home</a>.</p>
  </div>

  <!-- Live password-check script (client-side convenience only; server must still enforce policy & reuse checks) -->
  <script>
  (function() {
    // Policy (must match server-side)
    const MIN_LENGTH = 12;
    const COMMON = new Set([
      "password","123456","123456789","qwerty","12345678","111111","1234567",
      "iloveyou","123123","abc123","password1","admin","letmein","welcome","monkey"
    ].map(s => s.toLowerCase()));

    function $(sel){ return document.querySelector(sel); }

    function wire() {
      const passwordInput = $('#reset_new_password');
      const confirmInput = $('#reset_confirm_password');
      const submitBtn = $('#reset_password_submit');
      const checklistRoot = $('#reset_pw_checklist');
      if (!passwordInput || !checklistRoot) return;

      checklistRoot.innerHTML = `
        <div class="pw-checklist">
          <div class="pw-item" data-rule="length"><span class="pw-dot"></span> Minimum ${MIN_LENGTH} characters</div>
          <div class="pw-item" data-rule="upper"><span class="pw-dot"></span> At least one uppercase letter (A-Z)</div>
          <div class="pw-item" data-rule="lower"><span class="pw-dot"></span> At least one lowercase letter (a-z)</div>
          <div class="pw-item" data-rule="digit"><span class="pw-dot"></span> At least one digit (0-9)</div>
          <div class="pw-item" data-rule="special"><span class="pw-dot"></span> At least one special character (e.g. !@#$%^&*)</div>
          <div class="pw-item" data-rule="common"><span class="pw-dot"></span> Not a common password</div>
          <div class="pw-item" data-rule="match"><span class="pw-dot"></span> Password and confirmation match</div>
          <div class="pw-hint">Tip: Use a passphrase or a password manager to generate long, unique passwords.</div>
        </div>`;

      const items = {};
      checklistRoot.querySelectorAll('.pw-item').forEach(el => items[el.getAttribute('data-rule')] = el);

      function setOk(rule, ok) {
        const el = items[rule];
        if (!el) return;
        const dot = el.querySelector('.pw-dot');
        el.classList.toggle('ok', ok);
        el.classList.toggle('fail', !ok);
        dot.classList.toggle('ok', ok);
        dot.classList.toggle('fail', !ok);
      }

      function validateAll() {
        const pw = passwordInput.value || "";
        const confirm = confirmInput ? (confirmInput.value || "") : "";

        const hasLen = pw.length >= MIN_LENGTH;
        const hasUpper = /[A-Z]/.test(pw);
        const hasLower = /[a-z]/.test(pw);
        const hasDigit = /[0-9]/.test(pw);
        const hasSpecial = /[^A-Za-z0-9]/.test(pw);
        const isCommon = COMMON.has(pw.toLowerCase()) && pw.length > 0;
        const matches = (confirmInput ? (pw === confirm && pw.length>0) : true);

        setOk('length', hasLen);
        setOk('upper', hasUpper);
        setOk('lower', hasLower);
        setOk('digit', hasDigit);
        setOk('special', hasSpecial);
        setOk('common', !isCommon);
        setOk('match', matches);

        const passed = hasLen && hasUpper && hasLower && hasDigit && hasSpecial && !isCommon && matches;

        if (submitBtn) {
          submitBtn.disabled = !passed;
          submitBtn.classList.toggle('pw-submit-disabled', !passed);
        }
        return passed;
      }

      passwordInput.addEventListener('input', validateAll);
      if (confirmInput) confirmInput.addEventListener('input', validateAll);
      validateAll();

      const form = passwordInput.closest('form');
      if (form) {
        form.addEventListener('submit', function(e) {
          if (!validateAll()) {
            e.preventDefault();
            const firstFail = checklistRoot.querySelector('.pw-item.fail');
            if (firstFail) firstFail.scrollIntoView({behavior:'smooth', block:'center'});
            return false;
          }
        });
      }
    }

    document.addEventListener('DOMContentLoaded', wire);
  })();
  </script>
</body>
</html>
